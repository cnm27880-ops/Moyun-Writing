<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="墨韻 MòYùn - AI 協作小說寫作平台，支援離線寫作與智能續寫">
    <meta name="theme-color" content="#F5F5F0">

    <!-- Content Security Policy for XSS Protection -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com https://apis.google.com https://accounts.google.com https://*.firebasedatabase.app;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.gstatic.com https://*.openrouter.ai https://api.openai.com https://openrouter.ai wss://*.firebaseio.com https://yinli.one https://accounts.google.com https://*.firebaseapp.com https://*.firebasedatabase.app wss://*.firebasedatabase.app;
        img-src 'self' data: https: blob:;
        frame-src 'self' https://*.firebaseapp.com https://*.google.com https://accounts.google.com https://*.firebasedatabase.app;
        object-src 'none';
        base-uri 'self';
        form-action 'self' https://*.firebaseapp.com https://*.google.com https://accounts.google.com;
        upgrade-insecure-requests;
    ">

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- Apple iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="墨韻">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">

    <title>墨韻 MòYùn - AI 協作小說寫作平台</title>
    
    <!-- Google Fonts: LXGW WenKai TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@300;400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDK (compat version for easier migration) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    
    <!-- External Stylesheet -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
        <!-- Overlay -->
        <div class="overlay" id="overlay"></div>

        <!-- Smart Floating Navbar -->
        <nav class="navbar" id="navbar">
            <button class="navbar-btn" id="menuBtn" aria-label="開啟文檔列表">
                <span>☰</span>
            </button>
            <div class="navbar-title">
                <span class="navbar-title-text" id="navTitle">未命名文檔</span>
            </div>
            <button class="focus-mode-btn" id="focusModeBtn" aria-label="閱讀模式" title="閱讀模式">
                <span class="eye-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </span>
            </button>
            <div class="network-status" id="networkStatus" title="網路狀態">
                <span class="status-indicator online">●</span>
                <span class="status-text">線上</span>
            </div>
            <button class="navbar-btn" id="brainBtn" aria-label="開啟設定面板">
                <span class="settings-icon">
                    <span class="tooth"></span>
                    <span class="tooth"></span>
                    <span class="tooth"></span>
                    <span class="tooth"></span>
                    <span class="tooth"></span>
                    <span class="tooth"></span>
                    <span class="tooth"></span>
                    <span class="tooth"></span>
                </span>
            </button>
        </nav>

        <!-- Left Drawer - Document List -->
        <aside class="drawer-left" id="drawerLeft">
            <div class="drawer-header">
                <div class="drawer-logo">墨</div>
                <span class="drawer-brand">墨韻 MòYùn</span>
            </div>
            <!-- User Panel - Login/Sync Status -->
            <div class="user-panel" id="userPanel">
                <!-- Logged Out State -->
                <button class="login-btn" id="loginBtn">
                    <span class="google-icon">G</span>
                    <span>登入以同步</span>
                </button>
                <!-- Logged In State (hidden by default) -->
                <div class="user-info hidden" id="userInfo">
                    <div class="user-avatar" id="userAvatar">
                        <img src="" alt="Avatar" id="userAvatarImg">
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">使用者</div>
                        <div class="sync-status">
                            <span class="sync-dot" id="syncDot"></span>
                            <span id="syncText">已同步</span>
                        </div>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="登出">
                        <span class="logout-icon"><span class="arrow"></span></span>
                    </button>
                </div>
            </div>
            <div class="drawer-content">
                <button class="new-doc-btn" id="newDocBtn">
                    <span>✨</span>
                    <span>新增文檔</span>
                </button>
                <div class="doc-list-title">我的文檔</div>
                <div class="doc-list" id="docList">
                    <!-- Document items will be rendered here -->
                </div>
            </div>
        </aside>

        <!-- Right Panel - The Brain -->
        <aside class="panel-right" id="panelRight">
            <div class="panel-header">
                <h2 class="panel-title">
                    <span>🧠</span>
                    <span>控制塔</span>
                </h2>
                <button class="panel-close" id="panelClose">×</button>
            </div>
            <div class="panel-tabs">
                <button class="panel-tab active" data-panel="memory">記憶庫</button>
                <button class="panel-tab" data-panel="director">角色</button>
                <button class="panel-tab" data-panel="settings">設定</button>
                <button class="panel-tab" data-panel="stats">統計</button>
            </div>
            <div class="panel-content">
                <!-- Memory Section -->
                <div class="panel-section active" id="memorySection">
                    <button class="checkpoint-btn" id="checkpointBtn">
                        <span>✨</span>
                        <span>本章結算 (Checkpoint)</span>
                    </button>

                    <!-- 故事錨點 -->
                    <div class="memory-block">
                        <div class="memory-header">
                            <span class="memory-label">
                                <span>🎯</span>
                                <span>故事錨點</span>
                            </span>
                            <span class="memory-badge anchor">Scene</span>
                        </div>
                        <p class="memory-hint">關注：時間、地點、氛圍、衝突</p>
                        <textarea class="memory-textarea" id="storyAnchors" spellcheck="false">{
  "時間地點": "",
  "環境氛圍": "",
  "當前衝突": "",
  "禁止發生的劇情": []
}</textarea>
                    </div>

                    <!-- 角色印象筆記 -->
                    <div class="memory-block">
                        <div class="memory-header">
                            <span class="memory-label">
                                <span>🎭</span>
                                <span>角色印象筆記</span>
                            </span>
                            <button class="extract-btn" id="extractCharacterBtn" title="擷取生成">🔄 擷取生成</button>
                        </div>
                        <p class="memory-hint">關注：身分背景、狀態、角色理解</p>
                        <!-- 角色標籤切換 -->
                        <div class="character-note-tabs" id="characterNoteTabs">
                            <button class="character-note-tab active" data-role="ai">🤖 AI 主筆角色</button>
                            <button class="character-note-tab" data-role="user">👤 用戶主筆角色</button>
                        </div>
                        <!-- AI 主筆角色筆記 -->
                        <div class="character-note-content active" id="aiCharacterNote" data-role="ai">
                            <textarea class="memory-textarea character-note" id="aiCharacterNoteText" spellcheck="false" placeholder="AI 主筆角色的印象筆記...
{
  &quot;角色名稱&quot;: &quot;&quot;,
  &quot;身分本質&quot;: &quot;&quot;,
  &quot;當前狀態&quot;: &quot;&quot;,
  &quot;性格特質&quot;: &quot;&quot;,
  &quot;關鍵經歷&quot;: &quot;&quot;
}"></textarea>
                        </div>
                        <!-- 用戶主筆角色筆記 -->
                        <div class="character-note-content" id="userCharacterNote" data-role="user">
                            <textarea class="memory-textarea character-note" id="userCharacterNoteText" spellcheck="false" placeholder="用戶主筆角色的印象筆記...
{
  &quot;角色名稱&quot;: &quot;&quot;,
  &quot;身分本質&quot;: &quot;&quot;,
  &quot;當前狀態&quot;: &quot;&quot;,
  &quot;性格特質&quot;: &quot;&quot;,
  &quot;關鍵經歷&quot;: &quot;&quot;
}"></textarea>
                        </div>
                    </div>

                    <!-- 文風指紋 -->
                    <div class="memory-block">
                        <div class="memory-header">
                            <span class="memory-label">
                                <span>🖋️</span>
                                <span>文風指紋</span>
                            </span>
                            <span class="memory-badge style">Style</span>
                        </div>
                        <textarea class="memory-textarea" id="styleFingerprint" spellcheck="false">{
  "敘事節奏": "",
  "感官偏好": [],
  "禁忌與張力處理": "",
  "關鍵語氣樣本": []
}</textarea>
                    </div>
                </div>

                <!-- Director Section - 角色心理混音台 -->
                <div class="panel-section" id="directorSection">
                    <div class="director-section">
                        <div class="director-header">
                            <span class="director-title">
                                <span>🎬</span>
                                <span>角色導演</span>
                            </span>
                            <button class="add-character-btn" id="addCharacterBtn">+ 新增角色</button>
                        </div>
                        <div class="director-focus-bar" id="directorFocusBar"></div>
                        <div class="character-list" id="characterList">
                            <!-- Character cards will be rendered here -->
                            <div class="character-empty" id="characterEmpty">
                                <div class="character-empty-icon">🎭</div>
                                <p class="character-empty-text">尚未建立角色<br>點擊上方按鈕新增</p>
                            </div>
                        </div>
                    </div>

                    <!-- Inspiration Drawer - 靈感抽屜 -->
                    <div class="inspiration-drawer">
                        <div class="inspiration-header">
                            <span class="inspiration-title">
                                <span>💡</span>
                                <span>靈感抽屜</span>
                            </span>
                            <button class="generate-conflict-btn" id="generateConflictBtn">🎲 隨機衝突</button>
                        </div>
                        <div class="inspiration-content" id="inspirationContent">
                            <div class="inspiration-empty">
                                <div class="inspiration-empty-icon">✨</div>
                                <p class="inspiration-empty-text">點擊上方按鈕<br>根據角色驅動力生成劇情靈感</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section (Merged with World) -->
                <div class="panel-section" id="settingsSection">
                    <!-- Cloud Status & Backup -->
                    <div class="setting-group">
                        <label class="setting-label">☁️ 雲端狀態與備份</label>
                        <div class="cloud-status-box">
                            <div class="cloud-status-info">
                                <span class="status-indicator-text">🟢 目前共有 <span id="deviceCount">1</span> 台裝置連線中</span>
                            </div>
                            <button class="action-btn" id="createBackupBtn" style="margin-top: 12px;">💾 手動建立備份</button>
                            <button class="action-btn danger" id="forceFixCloudBtn" style="margin-top: 8px;">🔧 強制用本地覆蓋雲端</button>
                            <div class="backup-list-container" id="backupList" style="margin-top: 16px;">
                                <!-- Backup list will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">🌍 世界觀設定</label>
                        <!-- World Library Toolbar -->
                        <div class="world-library-toolbar">
                            <div class="world-library-row">
                                <select class="world-select" id="worldLibrarySelect">
                                    <option value="">-- 從圖書館選擇 --</option>
                                </select>
                            </div>
                            <div class="world-library-row">
                                <input type="text" class="world-name-input" id="worldNameInput" placeholder="輸入世界觀名稱...">
                                <div class="world-btn-group">
                                    <button class="world-btn save-btn" id="worldSaveBtn">💾 儲存</button>
                                    <button class="world-btn delete-btn" id="worldDeleteBtn" disabled>🗑️ 刪除</button>
                                </div>
                            </div>
                            <p class="world-library-hint">儲存常用世界觀，在不同文檔間快速切換</p>
                        </div>
                        <textarea class="setting-textarea" id="worldSetting" placeholder="描述你的故事世界觀、背景設定、魔法系統等..." spellcheck="false"></textarea>
                        <p class="setting-hint">此內容會作為每次請求的背景知識</p>
                        <div class="world-btn-group" style="margin-top: 8px;">
                            <button class="world-btn save-btn" id="setDefaultWorldBtn" style="font-size: 13px;">⭐ 設為預設</button>
                            <button class="world-btn" id="restoreDefaultWorldBtn" style="font-size: 13px; background: #607D8B;">↩️ 回復預設</button>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">📝 自訂 System Prompt</label>
                        <textarea class="setting-textarea" id="customPrompt" spellcheck="false">你是一位資深小說家，擅長細膩的心理描寫與環境塑造。請以第三人稱視角續寫故事，保持文風一致，注重角色內心活動的刻畫。每次續寫至少 1200 字，描寫要具體且富有畫面感。</textarea>
                        <p class="setting-hint">此內容會作為 AI 的基礎行為指令</p>
                        <div class="world-btn-group" style="margin-top: 8px;">
                            <button class="world-btn save-btn" id="setDefaultPromptBtn" style="font-size: 13px;">⭐ 設為預設</button>
                            <button class="world-btn" id="restoreDefaultPromptBtn" style="font-size: 13px; background: #607D8B;">↩️ 回復預設</button>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">API 格式</label>
                        <select class="setting-select" id="apiFormat">
                            <option value="openrouter">OpenRouter</option>
                            <option value="openai">OpenAI Compatible</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">API Endpoint</label>
                        <div class="combo-select-wrapper">
                            <select class="combo-select" id="endpointSelect">
                                <option value="">-- 選擇或輸入新端點 --</option>
                            </select>
                            <input type="text" class="setting-input combo-input" id="apiEndpoint" placeholder="https://openrouter.ai/api/v1/chat/completions">
                            <button type="button" class="combo-delete-btn" id="deleteEndpointBtn" title="刪除此端點">🗑️</button>
                        </div>
                        <p class="setting-hint">從歷史記錄選擇，或輸入新端點（儲存後會自動記錄）</p>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">API Key</label>
                        <input type="password" class="setting-input" id="apiKey" placeholder="sk-...">
                        <p class="setting-hint">僅儲存於本機，不會同步到雲端</p>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">模型名稱</label>
                        <div class="combo-select-wrapper">
                            <select class="combo-select" id="modelSelect">
                                <option value="">-- 選擇或輸入新模型 --</option>
                            </select>
                            <input type="text" class="setting-input combo-input" id="modelName" placeholder="anthropic/claude-sonnet-4">
                            <button type="button" class="combo-delete-btn" id="deleteModelBtn" title="刪除此模型">🗑️</button>
                        </div>
                        <p class="setting-hint">從歷史記錄選擇，或輸入新模型（儲存後會自動記錄）</p>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Temperature (創意度)</label>
                        <div class="setting-range-wrapper">
                            <input type="range" class="setting-range" id="temperature" min="0" max="2" step="0.1" value="0.8">
                            <span class="setting-range-value" id="tempValue">0.8</span>
                        </div>
                    </div>

                    <div class="action-btns">
                        <button class="action-btn" id="saveSettingsBtn">💾 儲存設定</button>
                        <button class="action-btn danger" id="clearAllBtn">🗑️ 清除全部</button>
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="panel-section" id="statsSection">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalChars">0</div>
                            <div class="stat-label">總字數</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statUserChars">0</div>
                            <div class="stat-label">用戶字數</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statAiChars">0</div>
                            <div class="stat-label">AI 字數</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statParagraphs">0</div>
                            <div class="stat-label">段落數</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="editor-container">
                <div class="editor-paper">
                    <div class="editor-body" id="editorBody">
                        <!-- Paragraphs rendered here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <div class="input-area" id="inputArea">
            <div class="input-wrapper">
                <!-- Style Tag Bar -->
                <div class="style-tag-bar" id="styleTagBar">
                    <button class="director-mode-toggle" id="directorModeToggle" title="導演模式">
                        <span>🎬</span>
                    </button>
                    <div class="style-tag-divider"></div>
                    <button class="style-tag" data-style="immersive" title="沉浸描寫">
                        <span class="style-tag-icon">🍃</span>
                    </button>
                    <button class="style-tag" data-style="dialogue" title="對話互動">
                        <span class="style-tag-icon">🗨️</span>
                    </button>
                    <button class="style-tag" data-style="action" title="動作場面">
                        <span class="style-tag-icon">⚡</span>
                    </button>
                    <button class="style-tag" data-style="psychology" title="心理獨白">
                        <span class="style-tag-icon">💭</span>
                    </button>
                    <button class="style-tag" data-style="spicy" title="張力/尺度">
                        <span class="style-tag-icon">🌹</span>
                    </button>
                </div>

                <div style="display: flex; gap: var(--spacing-sm); align-items: flex-end;">
                    <div class="input-field-wrapper" id="inputFieldWrapper">
                        <textarea class="input-field" id="inputField" placeholder="繼續你的故事..." rows="1" spellcheck="false"></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" aria-label="送出">
                        <span>➤</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Text Selection Menu - 已移除，功能整合到長按選單 -->

        <!-- Focus Mode Exit Overlay -->
        <div class="focus-mode-exit" id="focusModeExit"></div>
        <div class="focus-hint">點擊任意處退出閱讀模式</div>

        <!-- Edit Canvas - 獨立編輯畫布 -->
        <div class="edit-canvas" id="editCanvas">
            <div class="edit-canvas-header">
                <button class="edit-canvas-btn cancel" id="editCanvasCancel">取消</button>
                <span class="edit-canvas-title">編輯段落</span>
                <button class="edit-canvas-btn confirm" id="editCanvasConfirm">完成</button>
            </div>
            <textarea class="edit-canvas-textarea" id="editCanvasTextarea" placeholder="編輯你的文字..." spellcheck="false"></textarea>
            <!-- AI 輔助功能按鈕組 -->
            <div class="edit-canvas-ai-actions" id="editCanvasAiActions">
                <button class="edit-canvas-ai-btn refine" id="editCanvasRefine">
                    <span>✨</span>
                    <span>潤飾全文</span>
                </button>
                <button class="edit-canvas-ai-btn expand" id="editCanvasExpand">
                    <span>➕</span>
                    <span>擴寫全文</span>
                </button>
            </div>
            <button class="edit-canvas-delete" id="editCanvasDelete">
                <span>🗑️</span>
                <span>刪除此段落</span>
            </button>
        </div>

        <!-- Action Sheet - 段落操作選單 -->
        <div class="action-sheet-overlay" id="actionSheetOverlay"></div>
        <div class="action-sheet" id="actionSheet">
            <div class="action-sheet-header">
                <span class="action-sheet-title">段落操作</span>
            </div>
            <div class="action-sheet-content">
                <button class="action-sheet-btn" id="actionSheetEdit">
                    <span class="action-sheet-icon">✏️</span>
                    <span>進入編輯畫布</span>
                </button>
                <button class="action-sheet-btn" id="actionSheetRefine">
                    <span class="action-sheet-icon">✨</span>
                    <span>潤飾段落</span>
                </button>
                <button class="action-sheet-btn" id="actionSheetExpand">
                    <span class="action-sheet-icon">➕</span>
                    <span>擴寫段落</span>
                </button>
                <button class="action-sheet-btn danger" id="actionSheetDelete">
                    <span class="action-sheet-icon">🗑️</span>
                    <span>刪除段落</span>
                </button>
            </div>
            <button class="action-sheet-cancel" id="actionSheetCancel">取消</button>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Title Edit Modal -->
        <div class="modal-overlay" id="titleModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">編輯標題</h3>
                    <button class="modal-close" id="titleModalClose">×</button>
                </div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="titleModalInput" placeholder="輸入新標題...">
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" id="titleModalCancel">取消</button>
                    <button class="modal-btn confirm" id="titleModalConfirm">確認</button>
                </div>
            </div>
        </div>

        <!-- Confirm Modal -->
        <div class="modal-overlay" id="confirmModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="confirmModalTitle">確認</h3>
                    <button class="modal-close" id="confirmModalClose">×</button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage"></p>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" id="confirmModalCancel">取消</button>
                    <button class="modal-btn confirm" id="confirmModalConfirm">確認</button>
                </div>
            </div>
        </div>
    </div>


    <!-- External JavaScript Modules -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/offline.js"></script>
    <script src="js/ui.js"></script>
    <!-- Refactored Modules -->
    <script src="js/doc-manager.js"></script>
    <script src="js/char-manager.js"></script>
    <script src="js/ai-engine.js"></script>
    <script src="js/auth-manager.js"></script>
    <!-- Main Application -->
    <script src="js/app.js"></script>
</body>
</html>
